# SECURITY ASSESSMENT REPORT

## BitShipper AI API Gateway (apigateway01/apigateway02)
**Penetration Test Report**

**Date:** March 5, 2025  
**Report Version:** 1.0  
**Classification:** CONFIDENTIAL

---

## 1. EXECUTIVE SUMMARY

### 1.1 Overview

SecureVector Labs was engaged by BitShipper AI to conduct a penetration test of the API Gateway services (apigateway01: Java/Spring Boot and apigateway02: TypeScript/Node.js/Passport.js) that serve as the central access points for all BitShipper services. The assessment was performed between February 15, 2025, and March 1, 2025, using a combination of automated scanning tools and manual testing techniques.

### 1.2 Risk Summary

| Risk Level | Count |
|------------|-------|
| Critical   | 1     |
| High       | 4     |
| Medium     | 5     |
| Low        | 3     |
| Info       | 4     |

### 1.3 Key Findings

The assessment identified several significant security issues that require immediate attention:

1. **Broken authentication mechanism** in the Node.js Passport.js implementation allowing token reuse across services.
2. **Missing access controls** between internal API endpoints in the Spring Boot gateway.
3. **Inadequate rate limiting** in both gateways enabling API abuse and denial of service.
4. **Improper error handling** in Spring Boot exposing sensitive system information.
5. **Insufficient logging** of security-relevant events across both gateway implementations.

---

## 2. METHODOLOGY

The assessment followed a structured methodology:

1. **Reconnaissance**: Gathering information about the API Gateway architecture
2. **Scanning**: Identifying potential vulnerabilities using automated tools
3. **Vulnerability Analysis**: Evaluating discovered vulnerabilities
4. **Exploitation**: Attempting to exploit identified vulnerabilities
5. **Post-Exploitation**: Determining the impact of successful exploits
6. **Reporting**: Documenting findings and recommendations

---

## 3. FINDINGS

### 3.1 Critical Findings

#### 3.1.1 Broken Authentication Mechanism
**Severity: Critical**

**Description:**  
The Node.js/Passport.js API Gateway's (apigateway02) authentication mechanism allows JWT tokens issued for one service to be reused for accessing other services without proper validation of the intended audience or scope.

**Evidence:**  
A JWT token obtained for the tracking service could be used to access the billing service API endpoints without modification. The token validation process in the Passport.js middleware does not properly check the "aud" (audience) claim or enforce scope restrictions. The following code snippet from the gateway shows the issue:

```javascript
// Vulnerable code in apigateway02
passport.use(new JwtStrategy({
  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
  secretOrKey: process.env.JWT_SECRET
}, (jwt_payload, done) => {
  // Missing audience and scope validation
  return done(null, jwt_payload);
}));
```

**Impact:**  
This vulnerability allows an attacker who has obtained a valid token for any service to potentially access all other services protected by the API Gateway. This represents a complete authentication bypass for the entire API ecosystem.

### 3.2 High Findings

#### 3.2.1 Missing Access Controls Between Internal API Endpoints
**Severity: High**

**Description:**  
The Spring Boot API Gateway (apigateway01) has insufficient authorization checks between different internal API endpoints. The gateway relies primarily on authentication but lacks proper authorization controls.

**Evidence:**  
After authenticating as a standard user with read-only permissions, we were able to access administrative endpoints such as `/api/admin/users` and `/api/admin/system-config` without any additional authorization checks. The Spring Security configuration uses a simplistic approach that only checks for authentication:

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .antMatchers("/api/public/**").permitAll()
            .anyRequest().authenticated() // Only checks if authenticated, not authorization
            .and()
            .oauth2ResourceServer().jwt();
    }
}
```

**Impact:**  
This allows authenticated users to potentially access functionality and data beyond their intended permissions, leading to privilege escalation and unauthorized data access.

#### 3.2.2 Inadequate Rate Limiting
**Severity: High**

**Description:**  
Both API Gateways implement basic rate limiting, but it can be easily bypassed by rotating IP addresses or using multiple API keys.

**Evidence:**  
We were able to send over 10,000 requests per minute to critical API endpoints by rotating through a small pool of IP addresses, potentially enabling denial of service attacks or aggressive data harvesting. The Node.js gateway uses a simple in-memory rate limiter without distributed rate limiting across the Kubernetes cluster:

```javascript
// Vulnerable rate limiting in apigateway02
const rateLimit = require("express-rate-limit");

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: "Too many requests from this IP, please try again later"
});

app.use("/api/", apiLimiter);
```

**Impact:**  
Without proper rate limiting, the API is vulnerable to abuse, scraping, denial of service attacks, and brute force attempts against authentication endpoints.

#### 3.2.3 Improper Error Handling
**Severity: High**

**Description:**  
The Spring Boot API Gateway (apigateway01) returns verbose error messages that include sensitive information such as stack traces, server configurations, and internal IP addresses.

**Evidence:**  
By sending malformed requests to various endpoints, we were able to trigger detailed error responses that revealed:
- Internal network architecture
- Server hostnames and IP addresses
- Database connection strings (Aurora PostgreSQL)
- Software versions and configurations

The Spring Boot application has the following property set in `application.properties`:
```
server.error.include-stacktrace=always
```

**Impact:**  
These detailed error messages provide valuable information to attackers for targeting specific vulnerabilities and mapping the internal network structure.

#### 3.2.4 Insecure Direct Object References in API Endpoints
**Severity: High**

**Description:**  
Multiple API endpoints proxied through the gateway allow access to resources via direct object references without proper authorization checks.

**Evidence:**  
By manipulating the shipment ID parameter in the URL `/api/v1/shipments/{id}`, we were able to access shipment details belonging to other customers simply by changing the ID value. The API Gateway does not perform additional authorization checks before forwarding requests to backend services.

**Impact:**  
This vulnerability allows authenticated users to access data belonging to other customers, potentially exposing sensitive business and personal information.

### 3.3 Medium Findings

#### 3.3.1 Insufficient Logging of Security-Relevant Events
**Severity: Medium**

**Description:**  
Both API Gateways do not maintain adequate logs of security-relevant events such as authentication failures, access control violations, and unusual API usage patterns.

**Evidence:**  
After performing multiple intentionally malicious actions (authentication bypass attempts, accessing unauthorized resources, etc.), we found that many of these actions were not logged at all in CloudWatch Logs, while others lacked important contextual information such as user identifiers, source IP addresses, or affected resources.

**Impact:**  
Insufficient logging hampers incident detection and response capabilities, making it difficult to identify and investigate security breaches.

#### 3.3.2 Lack of API Inventory and Documentation
**Severity: Medium**

**Description:**  
There is no comprehensive inventory or documentation of API endpoints, making it difficult to ensure that all endpoints are properly secured.

**Evidence:**  
During testing, we discovered several undocumented API endpoints that were accessible but not listed in the official API documentation or OpenAPI specifications. These endpoints were not properly protected by the API Gateway's security controls.

**Impact:**  
Undocumented API endpoints are likely to be overlooked in security reviews and may not implement the same security controls as documented endpoints.

#### 3.3.3 Missing Content Security Policy
**Severity: Medium**

**Description:**  
The API Gateway does not implement Content Security Policy (CSP) headers, increasing the risk of content injection attacks.

**Evidence:**  
HTTP responses from the API Gateway do not include Content-Security-Policy headers to restrict content sources. This was confirmed by examining responses from both the Java and Node.js gateways.

**Impact:**  
Without CSP, the API is more vulnerable to cross-site scripting (XSS) and data injection attacks if used in browser contexts.

#### 3.3.4 Insecure Cross-Origin Resource Sharing (CORS) Configuration
**Severity: Medium**

**Description:**  
Both API Gateways implement an overly permissive CORS policy, allowing requests from any origin.

**Evidence:**  
The API returns `Access-Control-Allow-Origin: *` headers, allowing any website to make cross-origin requests to the API. In the Spring Boot gateway, this is configured as:

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("*")  // Allows all origins
                .allowedMethods("*")  // Allows all methods
                .allowedHeaders("*"); // Allows all headers
    }
}
```

**Impact:**  
This configuration increases the risk of cross-site request forgery (CSRF) attacks and may allow malicious websites to interact with the API if user credentials are sent automatically.

#### 3.3.5 Unencrypted Data Storage in Cache
**Severity: Medium**

**Description:**  
The API Gateway caches sensitive response data in an unencrypted format in Redis, potentially exposing sensitive information.

**Evidence:**  
Examination of the Redis cache used by the API Gateway revealed unencrypted storage of sensitive response data, including customer information and partial shipment details.

**Impact:**  
If the Redis cache system is compromised, attackers could access sensitive data without needing to breach the primary data stores.

---

## 4. RECOMMENDATIONS

### 4.1 Critical Recommendations

1. **Implement proper JWT validation** in the Passport.js middleware including audience and scope checks to prevent token reuse across services. Use a library like `express-jwt` with proper configuration.

### 4.2 High Priority Recommendations

1. **Implement proper authorization checks** at the API Gateway level using Spring Security's method-level security with `@PreAuthorize` annotations and role-based access control.
2. **Enhance rate limiting mechanisms** by implementing a distributed rate limiter using Redis across the Kubernetes cluster, with per-user and per-IP limits.
3. **Implement proper error handling** in Spring Boot by setting `server.error.include-stacktrace=never` and creating custom error handlers that return standardized error responses without sensitive information.
4. **Fix all instances of insecure direct object references** by implementing proper authorization checks for all resource access at the gateway level.

### 4.3 Medium Priority Recommendations

1. **Enhance logging capabilities** to capture all security-relevant events with sufficient context for investigation, using structured logging and sending logs to CloudWatch.
2. **Create and maintain a comprehensive API inventory** using OpenAPI/Swagger specifications for all endpoints.
3. **Implement Content Security Policy headers** in both gateways to reduce the risk of content injection attacks.
4. **Restrict CORS policies** to only allow necessary origins rather than allowing all origins.
5. **Encrypt sensitive data in the Redis cache** using Redis Enterprise encryption features or by implementing application-level encryption before storing data in the cache.

---

## 5. CONCLUSION

The BitShipper AI API Gateway services contain several significant security vulnerabilities that could lead to unauthorized access to sensitive data and services. The most critical issues relate to broken authentication in the Node.js gateway and insufficient access controls in the Spring Boot gateway.

We recommend addressing the critical and high-priority findings immediately to protect the integrity of the API ecosystem and the sensitive data it processes. The Java Spring Boot gateway (apigateway01) requires improvements in error handling and authorization controls, while the Node.js gateway (apigateway02) needs significant enhancements to its authentication mechanisms and token validation.

The API Gateway serves as a central point of access for all BitShipper services, making its security particularly important. Strengthening the security of these components will have a positive impact on the security posture of the entire platform.

## 6. STRATEGIC CONSIDERATIONS FOR SECURITY INVESTMENTS

### 6.1 Investment Prioritization

1. **Authentication Architecture**: The critical JWT token vulnerability and other authentication issues suggest that investments should prioritize a comprehensive authentication architecture review and redesign rather than incremental fixes.

2. **API Gateway Consolidation**: The presence of two different API gateway implementations (Java/Spring Boot and Node.js/Passport.js) with similar vulnerabilities suggests that consolidating to a single, well-secured gateway implementation would be more efficient than securing both separately.

3. **Authorization Framework**: Multiple findings related to missing access controls and authorization checks indicate a need for a standardized authorization framework that can be consistently applied across all services behind the API gateway.

### 6.2 Technology-Specific Considerations

1. **Spring Security Expertise**: For the Java Spring Boot gateway (apigateway01), invest in proper Spring Security configuration and expertise, particularly around method-level security and proper error handling.

2. **Node.js Security Patterns**: For the Node.js gateway (apigateway02), focus on secure JWT implementation patterns and distributed rate limiting solutions compatible with the Kubernetes environment.

3. **API Security Tooling**: Consider investments in specialized API security tools that can continuously monitor API traffic patterns and detect anomalies or potential abuse.

### 6.3 Investment Cautions

1. **Avoid Premature Microservices Security**: While service mesh and microservices security tools might seem appealing, the findings indicate that basic API security fundamentals should be addressed first.

2. **Beware of Security Tool Proliferation**: Adding multiple security tools to monitor the API gateway could increase complexity without addressing the root causes identified in this assessment.

3. **Consider Migration Plans**: Security investments should align with any planned API gateway consolidation or migration efforts mentioned in the technical debt document to avoid securing components that may soon be replaced.

4. **Balance Performance and Security**: API gateways are performance-critical components. Security investments should carefully consider performance impacts, particularly for rate limiting and request validation controls.

---

**Report prepared by:**  
SecureVector Labs Assessment Team