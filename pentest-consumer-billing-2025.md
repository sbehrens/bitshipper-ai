# SECURITY ASSESSMENT REPORT

## BitShipper AI Consumer Billing Product (paymentsvc01/paymentsvc02)
**Penetration Test Report**

**Date:** February 15, 2025  
**Report Version:** 1.0  
**Classification:** CONFIDENTIAL

---

## 1. EXECUTIVE SUMMARY

### 1.1 Overview

CyberShield Security was engaged by BitShipper AI to conduct a penetration test of the Consumer Billing Product, which consists of the paymentsvc01 (Java/Spring Boot) and paymentsvc02 (TypeScript/Node.js/Stripe API) services. The assessment was performed between January 25, 2025, and February 10, 2025, using a combination of automated scanning tools and manual testing techniques.

### 1.2 Risk Summary

| Risk Level | Count |
|------------|-------|
| Critical   | 2     |
| High       | 3     |
| Medium     | 4     |
| Low        | 5     |
| Info       | 3     |

### 1.3 Key Findings

The assessment identified several significant security issues that require immediate attention:

1. **Insecure Direct Object References (IDOR)** in the Spring Boot billing API allowed unauthorized access to other customers' payment information.
2. **Excessive privilege assignments** for AWS IAM roles with unnecessary access to sensitive customer data in Aurora PostgreSQL and S3.
3. **Unencrypted storage of payment card details** in application logs and Kafka message streams.
4. **Weak JWT token management** in the Node.js payment service allowing session hijacking and account takeover.
5. **Insufficient input validation** enabling SQL injection in payment processing endpoints in the Java service.

---

## 2. METHODOLOGY

The assessment followed a structured methodology:

1. **Reconnaissance**: Gathering information about the target application
2. **Scanning**: Identifying potential vulnerabilities using automated tools
3. **Vulnerability Analysis**: Evaluating discovered vulnerabilities
4. **Exploitation**: Attempting to exploit identified vulnerabilities
5. **Post-Exploitation**: Determining the impact of successful exploits
6. **Reporting**: Documenting findings and recommendations

---

## 3. FINDINGS

### 3.1 Critical Findings

#### 3.1.1 Insecure Direct Object References (IDOR) in Billing API
**Severity: Critical**

**Description:**  
The Spring Boot billing API endpoints (paymentsvc01) allow direct references to customer billing records using sequential IDs. By manipulating these IDs, an authenticated user could access billing information belonging to other customers.

**Evidence:**  
By changing the customer ID parameter from `customer_id=12345` to `customer_id=12346` in the request URL `https://api.bitshipper.ai/billing/v1/invoices?customer_id=12345`, we were able to access another customer's complete billing history, including payment methods and transaction details. The Spring Security configuration lacked proper method-level security annotations (`@PreAuthorize`) to validate user access to specific customer records.

**Impact:**  
This vulnerability allows any authenticated user to access sensitive financial information of any other customer, potentially leading to privacy violations, financial fraud, and regulatory non-compliance including PCI DSS violations.

#### 3.1.2 Unencrypted Storage of Payment Card Details
**Severity: Critical**

**Description:**  
Full credit card numbers, expiration dates, and CVV codes were found stored in plaintext within application logs and debug outputs.

**Evidence:**  
Log files located in CloudWatch Logs and in the EFS mount at `/var/log/bitshipper/billing-service.log` contained multiple instances of complete credit card information in plaintext, including:
```
2025-01-28 14:23:15 [DEBUG] Processing payment for order #45678 with card: 4111-2222-3333-4444, exp: 09/27, CVV: 123
```
Additionally, we found unencrypted payment details in Kafka message streams used for event processing between services.

**Impact:**  
This violates PCI DSS requirements and exposes customers to financial fraud if logs are compromised. It also represents a significant compliance risk with potential for substantial fines and reputational damage.

### 3.2 High Findings

#### 3.2.1 Excessive Privilege Assignments
**Severity: High**

**Description:**  
AWS IAM roles and service accounts used by the billing application have unnecessarily broad permissions across multiple systems, violating the principle of least privilege.

**Evidence:**  
The `billing-service-role` IAM role has full administrative access (`*:*`) to Aurora PostgreSQL databases, S3 buckets containing customer data, and DynamoDB tables used by the shipping system, despite only requiring read access to customer data and write access to the payment system. Additionally, the Kubernetes service account used by the payment pods has excessive RBAC permissions.

**Impact:**  
If compromised, these over-privileged accounts could be used to access, modify, or delete data across multiple critical systems, significantly increasing the potential damage from a single breach.

#### 3.2.2 Weak Session Management
**Severity: High**

**Description:**  
The Node.js payment service (paymentsvc02) uses weak JWT token implementation and does not invalidate sessions after password changes or implement proper timeout controls.

**Evidence:**  
JWT tokens are signed with a weak algorithm (HS256) and use a static, hard-coded secret found in the Node.js application code. Additionally, tokens lack proper expiration claims and remain active even after password changes and user logout on other devices.

**Impact:**  
Attackers could predict or hijack user sessions, leading to unauthorized access to accounts and sensitive billing information.

#### 3.2.3 Insufficient Input Validation
**Severity: High**

**Description:**  
Several API endpoints in the Java Spring Boot billing system (paymentsvc01) lack proper input validation, making them vulnerable to SQL injection attacks against the Aurora PostgreSQL database.

**Evidence:**  
The search function at `/api/billing/search?term=` was vulnerable to SQL injection. Entering `term=test' OR 1=1--` returned all billing records in the database. The code uses string concatenation instead of parameterized queries or JPA repositories with proper parameter binding.

**Impact:**  
Successful exploitation could allow unauthorized access to the entire billing database, potentially exposing all customer payment information.

### 3.3 Medium Findings

#### 3.3.1 Missing Rate Limiting on Authentication Endpoints
**Severity: Medium**

**Description:**  
The login and password reset endpoints in the Node.js service (paymentsvc02) do not implement rate limiting, allowing unlimited authentication attempts.

**Evidence:**  
We were able to make over 1,000 authentication attempts in a short period without being blocked or delayed.

**Impact:**  
This vulnerability facilitates brute force attacks against user credentials, potentially leading to unauthorized account access.

#### 3.3.2 Insecure Password Storage
**Severity: Medium**

**Description:**  
User passwords in the Aurora PostgreSQL database are stored using outdated hashing algorithms (MD5) without proper salting.

**Evidence:**  
Analysis of the authentication process and database schema revealed the use of MD5 for password hashing, which is considered cryptographically broken. The Spring Security configuration does not use the recommended BCrypt password encoder.

**Impact:**  
Compromised password hashes could be easily cracked, exposing user credentials.

#### 3.3.3 Lack of Multi-Factor Authentication for Sensitive Operations
**Severity: Medium**

**Description:**  
The billing system does not require additional authentication factors for sensitive operations such as changing payment methods or updating billing information.

**Evidence:**  
Once logged in, users can perform all sensitive billing operations without additional verification.

**Impact:**  
If an account is compromised, attackers can make unauthorized changes to payment methods and billing details without additional barriers.

#### 3.3.4 Excessive Data Exposure in API Responses
**Severity: Medium**

**Description:**  
GraphQL API endpoints in the payment service return excessive user data beyond what is required for the specific function.

**Evidence:**  
The GraphQL endpoint at `/graphql` with the `getUser` query returns complete user details including payment history, shipping addresses, and personal information, even when only basic profile information is needed by the client application. The GraphQL resolvers do not implement field-level authorization.

**Impact:**  
This increases the risk of sensitive data exposure and violates the principle of data minimization.

---

## 4. RECOMMENDATIONS

### 4.1 Critical Recommendations

1. **Implement proper authorization checks** on all Spring Boot API endpoints using `@PreAuthorize` annotations and custom security expressions to prevent IDOR vulnerabilities.
2. **Remove all instances of plaintext payment card data** from logs and Kafka streams, implementing proper data masking for sensitive information using PCI DSS compliant methods.

### 4.2 High Priority Recommendations

1. **Review and reduce service account privileges** following the principle of least privilege for both AWS IAM roles and Kubernetes RBAC.
2. **Improve JWT token security** by using stronger algorithms (RS256), implementing proper expiration, and storing secrets securely in AWS Secrets Manager.
3. **Implement comprehensive input validation and parameterized queries** to prevent SQL injection, using JPA repositories or prepared statements.

### 4.3 Medium Priority Recommendations

1. **Implement rate limiting** on authentication endpoints to prevent brute force attacks.
2. **Update password storage** to use modern hashing algorithms (e.g., bcrypt, Argon2) with proper salting.
3. **Implement multi-factor authentication** for sensitive billing operations using AWS Cognito or a similar service.
4. **Review GraphQL resolvers** to implement field-level authorization and ensure only necessary data is returned for each function.

---

## 5. CONCLUSION

The BitShipper AI Consumer Billing Product contains several significant security vulnerabilities that could lead to unauthorized access to sensitive customer financial information. The most critical issues relate to access control weaknesses and improper handling of payment card data.

We recommend addressing the critical and high-priority findings immediately to protect customer data and ensure compliance with relevant regulations, including PCI DSS. The Java Spring Boot service (paymentsvc01) requires significant security hardening, particularly around input validation and authorization checks, while the Node.js service (paymentsvc02) needs improvements in session management and authentication controls.

## 6. STRATEGIC CONSIDERATIONS FOR SECURITY INVESTMENTS

### 6.1 Investment Prioritization

1. **PCI DSS Compliance Focus**: The critical findings related to unencrypted payment card data represent immediate compliance risks with potential regulatory penalties. Security investments should prioritize PCI DSS compliance controls before addressing lower-risk vulnerabilities.

2. **Access Control Framework**: Multiple findings (IDOR, excessive privileges) point to systemic access control weaknesses. Rather than point fixes, invest in a comprehensive access control framework that can be standardized across services.

3. **Secure Development Practices**: Many vulnerabilities (SQL injection, XSS, input validation) indicate gaps in secure coding practices. Investments in developer security training and automated security testing would address multiple findings simultaneously.

### 6.2 Technology-Specific Considerations

1. **Spring Security Expertise**: The Java Spring Boot service (paymentsvc01) has multiple security issues related to Spring Security configuration. Consider investing in specialized Spring Security expertise or training rather than general security resources.

2. **Node.js Authentication Hardening**: The Node.js service (paymentsvc02) shows specific weaknesses in JWT implementation. Security investments should include Node.js-specific authentication best practices and possibly a more robust authentication library.

### 6.3 Investment Cautions

1. **Avoid Premature Cloud Security Tools**: While cloud security tools might seem appealing, the findings indicate that basic application security issues should be addressed first before investing in advanced cloud security solutions.

2. **Beware of Point Solutions**: The related nature of many findings suggests that point solutions addressing individual vulnerabilities would be less effective than systemic improvements to security architecture and practices.

3. **Consider Technical Debt**: Several vulnerabilities appear related to technical debt in the billing services. Security investments should be coordinated with planned refactoring or migration efforts to avoid securing components that may soon be replaced.

---

**Report prepared by:**  
CyberShield Security Assessment Team